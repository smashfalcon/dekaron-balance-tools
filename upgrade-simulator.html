<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Upgrade Simulator</title>
  <!-- CDN imports for Chart.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    /* Discord-inspired dark theme */
    :root {
      --background: #2c2d31;
      --background-secondary: #36393f;
      --background-tertiary: #202225;
      --text-primary: #dcddde;
      --text-secondary: #b9bbbe;
      --text-muted: #72767d;
      --blurple: #5865f2;
      --red: #ed4245;
      --green: #3ba55c;
      --yellow: #faa61a;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--background);
      color: var(--text-primary);
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1rem;
    }

    h1, h2, h3, h4 {
      margin-bottom: 1rem;
      color: var(--text-primary);
    }

    .card {
      background-color: var(--background-secondary);
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }

    .grid {
      display: grid;
      gap: 1.5rem;
    }

    .grid-2 {
      grid-template-columns: 1fr;
    }

    @media (min-width: 768px) {
      .grid-2 {
        grid-template-columns: 1fr 1fr;
      }
    }

    input[type="number"] {
      background-color: #4f545c;
      color: var(--text-primary);
      border: none;
      padding: 0.5rem;
      border-radius: 4px;
      width: 100%;
      margin-bottom: 1rem;
    }

    select {
      background-color: #4f545c;
      color: var(--text-primary);
      border: none;
      padding: 0.5rem;
      border-radius: 4px;
      width: 100%;
      margin-bottom: 1rem;
    }

    button {
      background-color: var(--blurple);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    button:hover {
      background-color: #4752c4;
    }

    button:disabled {
      background-color: var(--text-muted);
      cursor: not-allowed;
    }

    label {
      display: block;
      margin-bottom: 0.5rem;
      color: var(--text-secondary);
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .error {
      color: var(--red);
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 0.5rem;
      text-align: left;
      border: 1px solid #555;
    }

    th {
      background-color: var(--background-tertiary);
    }

    tr:nth-child(even) {
      background-color: rgba(255, 255, 255, 0.05);
    }

    .chart-container {
      position: relative;
      height: 350px;
      width: 100%;
    }

    .text-right {
      text-align: right;
    }

    .text-center {
      text-align: center;
    }

    .text-muted {
      color: var(--text-secondary);
    }

    .mb-1 {
      margin-bottom: 0.5rem;
    }

    .mb-2 {
      margin-bottom: 1rem;
    }

    .mb-3 {
      margin-bottom: 1.5rem;
    }

    /* Percentile cards styling */
    .grid-3 {
      grid-template-columns: 1fr;
    }
    @media (min-width: 768px) {
      .grid-3 {
        grid-template-columns: 1fr 1fr 1fr;
      }
    }
    .percentile-card {
      padding: 1rem;
      border-radius: 4px;
      border-width: 2px;
      border-style: solid;
      margin-bottom: 1rem;
    }
    .percentile-card.lucky {
      background-color: rgba(59, 165, 92, 0.1);
      border-color: var(--green);
    }
    .percentile-card.average {
      background-color: rgba(250, 166, 26, 0.1);
      border-color: var(--yellow);
    }
    .percentile-card.unlucky {
      background-color: rgba(237, 66, 69, 0.1);
      border-color: var(--red);
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Upgrade Simulator</h1>

    <!-- Configuration Card -->
    <div class="card mb-3">
      <h2>Upgrade Configuration</h2>

      <div class="table-container mb-3">
        <table id="configurationTable">
          <thead>
            <tr>
              <th>Plus</th>
              <th class="text-right">Base Success Rate</th>
              <th>Talisman</th>
              <th class="text-right">Total Success Rate</th>
              <th class="text-right">Compound Success Rate</th>
            </tr>
          </thead>
          <tbody>
            <!-- Table rows will be added dynamically -->
          </tbody>
        </table>
      </div>

      <div class="grid grid-2">
        <div class="form-group">
          <label for="startingPoint">Starting Point</label>
          <select id="startingPoint">
            <option value="0" selected>+0</option>
            <option value="1">+1</option>
            <option value="2">+2</option>
            <option value="3">+3</option>
            <option value="4">+4</option>
            <option value="5">+5</option>
            <option value="6">+6</option>
            <option value="7">+7</option>
            <option value="8">+8</option>
          </select>
        </div>

        <div class="form-group">
          <label for="targetPlus">Target Plus Level</label>
          <select id="targetPlus">
            <option value="1">+1</option>
            <option value="2">+2</option>
            <option value="3">+3</option>
            <option value="4">+4</option>
            <option value="5">+5</option>
            <option value="6">+6</option>
            <option value="7">+7</option>
            <option value="8">+8</option>
            <option value="9" selected>+9</option>
          </select>
          <div id="targetError" class="error"></div>
        </div>
      </div>

      <!-- Swap the order: Confidence first, then Number of Sim Players -->
      <div class="form-group">
        <label for="confidenceLevel">Confidence Level (%)</label>
        <input type="number" id="confidenceLevel" min="1" max="99.99" step="0.01" value="95" />
      </div>

      <div class="form-group">
        <label for="numSimulatedPlayers">Number of Simulated Players</label>
        <input type="number" id="numSimulatedPlayers" min="1" max="100000" value="1000" />
      </div>

      <!-- Button renamed to "Run Simulation" -->
      <button id="runSimulationButton">Run Simulation</button>
    </div>

    <!-- Theoretical Results Card -->
    <div class="card mb-3">
      <h2>Theoretical Results</h2>
      <div id="resultsContainer" class="mb-3">
        <!-- Results will display here -->
      </div>
    </div>

    <!-- Theoretical Probability Chart Card -->
    <div class="card mb-3">
      <h2>Theoretical Probability Distribution</h2>
      <div class="chart-container">
        <canvas id="probabilityChart"></canvas>
      </div>
      <div id="confidenceInfo" class="mb-2 mt-2 text-center">
        <!-- Confidence level info will be displayed here -->
      </div>
    </div>

    <!-- Simulation Results: Distribution of Attempts -->
    <div class="card mb-3">
      <h2>Simulation Results: Distribution of Final Attempts</h2>
      <div class="chart-container">
        <canvas id="attemptsDistributionChart"></canvas>
      </div>
      <div class="text-center text-muted mt-2">
        Number of Attempts to Reach Target (in up to 20 ranges)
      </div>
    </div>

    <!-- Player Experience Insights -->
    <div class="card mb-3">
      <h2>Player Experience Insights</h2>
      <div class="grid grid-3" id="experienceInsights">
        <!-- Lucky (5th percentile) -->
        <div class="percentile-card lucky">
          <h4>Lucky Players (5th Percentile)</h4>
          <p class="text-muted">
            Attempts: <strong id="luckyAttempts">0</strong>
          </p>
          <p class="text-muted">
            Empirical Success Rate: <strong id="luckySuccessRate">0%</strong>
          </p>
        </div>
        <!-- Average (50th percentile) -->
        <div class="percentile-card average">
          <h4>Average Players (50th Percentile)</h4>
          <p class="text-muted">
            Attempts: <strong id="avgAttempts">0</strong>
          </p>
          <p class="text-muted">
            Empirical Success Rate: <strong id="avgSuccessRate">0%</strong>
          </p>
        </div>
        <!-- Unlucky (95th Percentile) -->
        <div class="percentile-card unlucky">
          <h4>Unlucky Players (95th Percentile)</h4>
          <p class="text-muted">
            Attempts: <strong id="unluckyAttempts">0</strong>
          </p>
          <p class="text-muted">
            Empirical Success Rate: <strong id="unluckySuccessRate">0%</strong>
          </p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // =============== STATE ===============
    const state = {
      // Default Talisman usage:
      // +1..+4 => None (index 0)
      // +5..+6 => +18% (index 1)
      // +7 => +20% (index 2)
      // +8 => +25% (index 3)
      // +9 => +30% (index 4)
      talismanStrategy: {
        1: 0,
        2: 0,
        3: 0,
        4: 0,
        5: 1,
        6: 1,
        7: 2,
        8: 3,
        9: 4
      },

      baseRates: {
        1: 0.95,
        2: 0.90,
        3: 0.85,
        4: 0.70,
        5: 0.60,
        6: 0.50,
        7: 0.30,
        8: 0.20,
        9: 0.10
      },
      talismanOptions: [
        { name: "None", rate: 0 },
        { name: "+18% Talisman", rate: 0.18 },
        { name: "+20% Talisman", rate: 0.20 },
        { name: "+25% Talisman", rate: 0.25 },
        { name: "+30% Talisman", rate: 0.30 },
        { name: "+50% Talisman", rate: 0.50 }
      ],

      // User inputs (defaults):
      startingPoint: 0,
      targetPlus: 9,
      confidenceLevel: 95,
      numSimulatedPlayers: 1000,

      // Computed compound rates (for theoretical, no-degrade)
      compoundRates: {},

      // Charts
      charts: {
        probability: null,
        attemptsDistribution: null
      },

      // Simulation results
      simulationAttempts: []
    };

    // =============== DOM REFS ===============
    const elements = {
      configurationTable: document.getElementById("configurationTable"),
      startingPoint: document.getElementById("startingPoint"),
      targetPlus: document.getElementById("targetPlus"),
      confidenceLevel: document.getElementById("confidenceLevel"),
      targetError: document.getElementById("targetError"),
      numSimulatedPlayers: document.getElementById("numSimulatedPlayers"),
      runSimulationButton: document.getElementById("runSimulationButton"),

      resultsContainer: document.getElementById("resultsContainer"),
      probabilityChart: document.getElementById("probabilityChart"),
      confidenceInfo: document.getElementById("confidenceInfo"),

      attemptsDistributionChart: document.getElementById("attemptsDistributionChart"),

      // Percentile Info
      luckyAttempts: document.getElementById("luckyAttempts"),
      luckySuccessRate: document.getElementById("luckySuccessRate"),
      avgAttempts: document.getElementById("avgAttempts"),
      avgSuccessRate: document.getElementById("avgSuccessRate"),
      unluckyAttempts: document.getElementById("unluckyAttempts"),
      unluckySuccessRate: document.getElementById("unluckySuccessRate")
    };

    // =============== INITIALIZATION ===============
    function initApp() {
      try {
        initConfigurationTable();
        attachEventListeners();
        validateSelections();

        // Immediately do an initial run (with default values)
        runAllCalculations();
      } catch (err) {
        console.error("Error during init:", err);
      }
    }

    // =============== CONFIG TABLE ===============
    function initConfigurationTable() {
      const tableBody = elements.configurationTable.querySelector("tbody");
      tableBody.innerHTML = "";

      calculateCompoundRates();

      for (let plus = 1; plus <= 9; plus++) {
        const row = document.createElement("tr");

        // Plus column
        const plusCell = document.createElement("td");
        plusCell.textContent = `+${plus}`;

        // Base Rate column
        const baseRateCell = document.createElement("td");
        baseRateCell.className = "text-right";
        baseRateCell.textContent = `${(state.baseRates[plus] * 100).toFixed(0)}%`;

        // Talisman column
        const talismanCell = document.createElement("td");
        const selectEl = document.createElement("select");
        selectEl.id = `talisman-${plus}`;

        state.talismanOptions.forEach((option, index) => {
          const opt = document.createElement("option");
          opt.value = index;
          opt.textContent = option.name;
          selectEl.appendChild(opt);
        });

        selectEl.value = state.talismanStrategy[plus];
        selectEl.addEventListener("change", (e) => {
          state.talismanStrategy[plus] = parseInt(e.target.value);
          updateConfigurationTable();
        });

        talismanCell.appendChild(selectEl);

        // Total Success Rate column
        const totalRateCell = document.createElement("td");
        totalRateCell.className = "text-right";
        totalRateCell.id = `total-rate-${plus}`;
        totalRateCell.textContent = calculateTotalSuccessRate(plus).toFixed(2) + "%";

        // Compound Success Rate column
        const compoundRateCell = document.createElement("td");
        compoundRateCell.className = "text-right";
        compoundRateCell.id = `compound-rate-${plus}`;
        compoundRateCell.textContent = (state.compoundRates[plus] * 100).toFixed(2) + "%";

        row.appendChild(plusCell);
        row.appendChild(baseRateCell);
        row.appendChild(talismanCell);
        row.appendChild(totalRateCell);
        row.appendChild(compoundRateCell);

        tableBody.appendChild(row);
      }
    }

    function updateConfigurationTable() {
      calculateCompoundRates();
      for (let plus = 1; plus <= 9; plus++) {
        const totalRateCell = document.getElementById(`total-rate-${plus}`);
        if (totalRateCell) {
          totalRateCell.textContent = calculateTotalSuccessRate(plus).toFixed(2) + "%";
        }
        const compoundRateCell = document.getElementById(`compound-rate-${plus}`);
        if (compoundRateCell) {
          compoundRateCell.textContent = (state.compoundRates[plus] * 100).toFixed(2) + "%";
        }
      }
    }

    // =============== EVENTS & VALIDATION ===============
    function attachEventListeners() {
      elements.startingPoint.addEventListener("change", () => {
        state.startingPoint = parseInt(elements.startingPoint.value);
        validateSelections();
      });

      elements.targetPlus.addEventListener("change", () => {
        state.targetPlus = parseInt(elements.targetPlus.value);
        validateSelections();
      });

      elements.confidenceLevel.addEventListener("input", () => {
        state.confidenceLevel = parseFloat(elements.confidenceLevel.value);
      });

      elements.numSimulatedPlayers.addEventListener("input", () => {
        state.numSimulatedPlayers = parseInt(elements.numSimulatedPlayers.value);
      });

      elements.runSimulationButton.addEventListener("click", () => {
        runAllCalculations();
      });
    }

    function validateSelections() {
      const sp = parseInt(elements.startingPoint.value);
      const tp = parseInt(elements.targetPlus.value);
      if (tp <= sp) {
        elements.targetError.textContent =
          "Target plus level must be higher than starting point.";
        return false;
      }
      elements.targetError.textContent = "";
      return true;
    }

    // =============== THEORETICAL CALCS (NO DEGRADE) ===============
    function calculateCompoundRates() {
      let compoundRate = 1.0;
      for (let plus = 1; plus <= 9; plus++) {
        const totalRate = calculateTotalSuccessRate(plus) / 100;
        compoundRate *= totalRate;
        state.compoundRates[plus] = compoundRate;
      }
    }

    function calculateTotalSuccessRate(plus) {
      const baseRate = state.baseRates[plus];
      const talismanIndex = state.talismanStrategy[plus];
      const talismanBoost = state.talismanOptions[talismanIndex].rate;
      return Math.min(100, (baseRate + talismanBoost) * 100);
    }

    function calculateSuccessProbability() {
      let startProb = 1.0;
      if (state.startingPoint > 0) {
        startProb = state.compoundRates[state.startingPoint];
      }
      const targetProb = state.compoundRates[state.targetPlus];
      return targetProb / startProb;
    }

    function calculateAverageAttempts() {
      const p = calculateSuccessProbability();
      return 1 / p;
    }

    function calculateConfidenceAttempts(confLevel) {
      const p = calculateSuccessProbability();
      const c = confLevel / 100;
      if (p < 1e-9) {
        return Number.MAX_SAFE_INTEGER;
      }
      const denominator = Math.log(1 - p);
      if (Math.abs(denominator) < 1e-9) {
        return Number.MAX_SAFE_INTEGER;
      }
      return Math.ceil(Math.log(1 - c) / denominator);
    }

    function updateTheoreticalDisplay() {
      const avgAttempts = calculateAverageAttempts();
      const confAttempts = calculateConfidenceAttempts(state.confidenceLevel);
      const successProb = calculateSuccessProbability();

      elements.resultsContainer.innerHTML = `
        <p class="mb-2">
          <strong>From +${state.startingPoint} to +${state.targetPlus} (no degrade theoretical):</strong>
        </p>
        <p class="mb-2">
          Expected attempts (theoretical): <strong>${avgAttempts.toFixed(2)}</strong>
        </p>
        <p class="mb-2">
          Success probability per attempt: <strong>${(successProb * 100).toFixed(2)}%</strong>
        </p>
        <p>
          Attempts for ${state.confidenceLevel}% confidence: <strong>${confAttempts}</strong>
        </p>
      `;
    }

    function generateProbabilityData() {
      const p = calculateSuccessProbability();
      const confAttempts = calculateConfidenceAttempts(state.confidenceLevel);

      const data = [];
      let cumProb = 0;
      for (let i = 1; i <= confAttempts; i++) {
        const prob = p * Math.pow(1 - p, i - 1);
        cumProb += prob;
        data.push({
          attempt: i,
          probability: prob,
          cumulativeProbability: cumProb
        });
      }
      return data;
    }

    function updateProbabilityChart() {
      if (state.charts.probability) {
        state.charts.probability.destroy();
      }
      if (!elements.probabilityChart) return;

      const data = generateProbabilityData();
      const chartData = {
        labels: data.map(d => d.attempt),
        datasets: [
          {
            label: "Success Probability",
            data: data.map(d => d.probability * 100),
            backgroundColor: "rgba(88, 101, 242, 0.5)",
            borderColor: "rgba(88, 101, 242, 1)",
            borderWidth: 1
          },
          {
            label: "Cumulative Probability",
            data: data.map(d => d.cumulativeProbability * 100),
            backgroundColor: "rgba(59, 165, 92, 0.5)",
            borderColor: "rgba(59, 165, 92, 1)",
            borderWidth: 1,
            type: "line"
          }
        ]
      };

      const ctx = elements.probabilityChart.getContext("2d");
      state.charts.probability = new Chart(ctx, {
        type: "bar",
        data: chartData,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              title: {
                display: true,
                text: "Number of Attempts",
                color: "#dcddde"
              },
              ticks: {
                color: "#b9bbbe"
              },
              grid: {
                color: "rgba(255, 255, 255, 0.1)"
              }
            },
            y: {
              title: {
                display: true,
                text: "Probability (%)",
                color: "#dcddde"
              },
              ticks: {
                color: "#b9bbbe"
              },
              grid: {
                color: "rgba(255, 255, 255, 0.1)"
              }
            }
          },
          plugins: {
            legend: {
              labels: {
                color: "#dcddde"
              }
            },
            tooltip: {
              callbacks: {
                label: (context) => {
                  const label = context.dataset.label || "";
                  const value = context.raw.toFixed(2);
                  return `${label}: ${value}%`;
                }
              }
            }
          }
        }
      });

      const confAttempts = calculateConfidenceAttempts(state.confidenceLevel);
      elements.confidenceInfo.innerHTML = `
        <div>
          <strong>${state.confidenceLevel}% Confidence (no degrade):</strong> 
          You need <strong>${confAttempts}</strong> attempts to have a 
          ${state.confidenceLevel}% chance of reaching +${state.targetPlus} from +${state.startingPoint}.
        </div>
      `;
    }

    // =============== SIMULATION (DEGRADE) ===============
    function runSimulation() {
      state.simulationAttempts = [];
      for (let i = 0; i < state.numSimulatedPlayers; i++) {
        let currentPlus = state.startingPoint;
        let attempts = 0;
        while (currentPlus < state.targetPlus) {
          attempts++;
          const successRate = calculateTotalSuccessRate(currentPlus + 1) / 100;
          if (Math.random() < successRate) {
            currentPlus++;
          } else {
            currentPlus = state.startingPoint;
          }
        }
        state.simulationAttempts.push(attempts);
      }
    }

    // =============== SIMULATION DISPLAY ===============
    function updateSimulationDisplay() {
      updateAttemptsDistributionChart();
      updatePercentileCards();
    }

    function buildAttemptsBins() {
      const sorted = state.simulationAttempts.slice().sort((a, b) => a - b);
      if (!sorted.length) {
        return { labels: [], counts: [] };
      }

      const binCount = 20;
      const minVal = sorted[0];
      const maxVal = sorted[sorted.length - 1];
      if (minVal === maxVal) {
        return {
          labels: [`${minVal}`],
          counts: [sorted.length]
        };
      }
      const range = maxVal - minVal + 1;
      const binSize = Math.ceil(range / binCount);

      const bins = [];
      for (let i = 0; i < binCount; i++) {
        const start = minVal + i * binSize;
        const end = start + binSize - 1;
        if (start > maxVal) break;
        bins.push({ start, end, count: 0 });
      }

      sorted.forEach(val => {
        const idx = Math.floor((val - minVal) / binSize);
        const clamped = Math.min(idx, bins.length - 1);
        bins[clamped].count++;
      });

      const labels = [];
      const counts = [];
      bins.forEach(b => {
        if (b.count > 0 || b.start <= maxVal) {
          let label = b.start === b.end ? `${b.start}` : `${b.start}-${b.end}`;
          labels.push(label);
          counts.push(b.count);
        }
      });
      return { labels, counts };
    }

    function updateAttemptsDistributionChart() {
      if (state.charts.attemptsDistribution) {
        state.charts.attemptsDistribution.destroy();
      }
      if (!elements.attemptsDistributionChart) return;

      const { labels, counts } = buildAttemptsBins();
      const chartData = {
        labels,
        datasets: [
          {
            label: "Number of Players",
            data: counts,
            backgroundColor: "#5865f2",
            borderColor: "#4752c4",
            borderWidth: 1
          }
        ]
      };

      const ctx = elements.attemptsDistributionChart.getContext("2d");
      state.charts.attemptsDistribution = new Chart(ctx, {
        type: "bar",
        data: chartData,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              title: {
                display: true,
                text: "Total Attempts (Binned)",
                color: "#dcddde"
              },
              ticks: {
                color: "#b9bbbe"
              },
              grid: {
                color: "rgba(255, 255, 255, 0.1)"
              }
            },
            y: {
              title: {
                display: true,
                text: "Number of Players",
                color: "#dcddde"
              },
              ticks: {
                color: "#b9bbbe"
              },
              grid: {
                color: "rgba(255, 255, 255, 0.1)"
              }
            }
          },
          plugins: {
            legend: {
              labels: {
                color: "#dcddde"
              }
            },
            tooltip: {
              callbacks: {
                label: function (context) {
                  return `${context.label}: ${context.parsed.y} players`;
                }
              }
            }
          }
        }
      });
    }

    function updatePercentileCards() {
      const sorted = state.simulationAttempts.slice().sort((a, b) => a - b);
      if (!sorted.length) return;

      const percentiles = [5, 50, 95];
      const results = {};
      percentiles.forEach(pct => {
        let idx = Math.floor((pct / 100) * sorted.length);
        if (idx >= sorted.length) idx = sorted.length - 1;
        if (idx < 0) idx = 0;
        const attempts = sorted[idx];

        const levelsGained = state.targetPlus - state.startingPoint;
        const successRate = attempts > 0 ? (levelsGained / attempts) : 1.0;

        results[pct] = { attempts, successRate };
      });

      elements.luckyAttempts.textContent = results[5].attempts;
      elements.luckySuccessRate.textContent =
        (results[5].successRate * 100).toFixed(2) + "%";

      elements.avgAttempts.textContent = results[50].attempts;
      elements.avgSuccessRate.textContent =
        (results[50].successRate * 100).toFixed(2) + "%";

      elements.unluckyAttempts.textContent = results[95].attempts;
      elements.unluckySuccessRate.textContent =
        (results[95].successRate * 100).toFixed(2) + "%";
    }

    // =============== MASTER FUNCTION ===============
    function runAllCalculations() {
      if (!validateSelections()) return;

      // Update state from DOM
      state.startingPoint = parseInt(elements.startingPoint.value);
      state.targetPlus = parseInt(elements.targetPlus.value);
      state.confidenceLevel = parseFloat(elements.confidenceLevel.value);
      state.numSimulatedPlayers = parseInt(elements.numSimulatedPlayers.value);

      if (state.confidenceLevel < 1) state.confidenceLevel = 1;
      if (state.confidenceLevel > 99.99) state.confidenceLevel = 99.99;

      // 1) Theoretical
      updateTheoreticalDisplay();
      updateProbabilityChart();

      // 2) Simulation
      runSimulation();
      updateSimulationDisplay();
    }

    document.addEventListener("DOMContentLoaded", initApp);
  </script>
</body>
</html>
