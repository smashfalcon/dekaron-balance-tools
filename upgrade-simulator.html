<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Effective Cost Calculator</title>
  <!-- CDN imports for Chart.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    /* Discord-inspired dark theme */
    :root {
      --background: #2c2d31;
      --background-secondary: #36393f;
      --background-tertiary: #202225;
      --text-primary: #dcddde;
      --text-secondary: #b9bbbe;
      --text-muted: #72767d;
      --blurple: #5865f2;
      --red: #ed4245;
      --green: #3ba55c;
      --yellow: #faa61a;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--background);
      color: var(--text-primary);
      line-height: 1.6;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1rem;
    }
    
    h1, h2, h3, h4 {
      margin-bottom: 1rem;
      color: var(--text-primary);
    }
    
    .card {
      background-color: var(--background-secondary);
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }
    
    .grid {
      display: grid;
      gap: 1.5rem;
    }
    
    .grid-2 {
      grid-template-columns: 1fr;
    }
    
    @media (min-width: 768px) {
      .grid-2 {
        grid-template-columns: 1fr 1fr;
      }
    }
    
    input[type="number"] {
      background-color: #4f545c;
      color: var(--text-primary);
      border: none;
      padding: 0.5rem;
      border-radius: 4px;
      width: 100%;
      margin-bottom: 1rem;
    }
    
    select {
      background-color: #4f545c;
      color: var(--text-primary);
      border: none;
      padding: 0.5rem;
      border-radius: 4px;
      width: 100%;
      margin-bottom: 1rem;
    }
    
    button {
      background-color: var(--blurple);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    button:hover {
      background-color: #4752c4;
    }
    
    button:disabled {
      background-color: var(--text-muted);
      cursor: not-allowed;
    }
    
    label {
      display: block;
      margin-bottom: 0.5rem;
      color: var(--text-secondary);
    }
    
    .form-group {
      margin-bottom: 1rem;
    }
    
    .error {
      color: var(--red);
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    th, td {
      padding: 0.5rem;
      text-align: left;
      border: 1px solid #555;
    }
    
    th {
      background-color: var(--background-tertiary);
    }
    
    tr:nth-child(even) {
      background-color: rgba(255, 255, 255, 0.05);
    }
    
    .chart-container {
      position: relative;
      height: 350px;
      width: 100%;
    }
    
    .text-right {
      text-align: right;
    }
    
    .text-center {
      text-align: center;
    }
    
    .text-muted {
      color: var(--text-secondary);
    }
    
    .mb-1 {
      margin-bottom: 0.5rem;
    }
    
    .mb-2 {
      margin-bottom: 1rem;
    }
    
    .mb-3 {
      margin-bottom: 1.5rem;
    }
    
    .note {
      background-color: var(--background-tertiary);
      padding: 1rem;
      border-radius: 4px;
      color: var(--text-secondary);
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Effective Cost Calculator</h1>
    
    <!-- Configuration Card -->
    <div class="card mb-3">
      <h2>Upgrade Configuration</h2>
      
      <div class="table-container mb-3">
        <table id="configurationTable">
          <thead>
            <tr>
              <th>Plus</th>
              <th class="text-right">Base Success Rate</th>
              <th>Talisman</th>
              <th class="text-right">Total Success Rate</th>
              <th class="text-right">Compound Success Rate</th>
            </tr>
          </thead>
          <tbody>
            <!-- Table rows will be added dynamically -->
          </tbody>
        </table>
      </div>
      
      <div class="grid grid-2">
        <div class="form-group">
          <label for="startingPoint">Starting Point</label>
          <select id="startingPoint">
            <option value="0">+0</option>
            <option value="1">+1</option>
            <option value="2">+2</option>
            <option value="3">+3</option>
            <option value="4">+4</option>
            <option value="5">+5</option>
            <option value="6">+6</option>
            <option value="7">+7</option>
            <option value="8">+8</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="targetPlus">Target Plus Level</label>
          <select id="targetPlus">
            <option value="1">+1</option>
            <option value="2">+2</option>
            <option value="3">+3</option>
            <option value="4">+4</option>
            <option value="5">+5</option>
            <option value="6">+6</option>
            <option value="7">+7</option>
            <option value="8">+8</option>
            <option value="9" selected>+9</option>
          </select>
          <div id="targetError" class="error"></div>
        </div>
      </div>
      
      <div class="form-group">
        <label for="confidenceLevel">Confidence Level (%)</label>
        <input type="number" id="confidenceLevel" min="1" max="99.99" step="0.01" value="95">
      </div>
      
      <button id="calculateButton">Calculate</button>
    </div>
    
    <!-- Results Card -->
    <div class="card mb-3">
      <h2>Results</h2>
      <div id="resultsContainer" class="mb-3">
        <p>Click "Calculate" to see the average number of attempts required.</p>
      </div>
    </div>
    
    <!-- Probability Chart Card -->
    <div class="card mb-3">
      <h2>Probability Distribution</h2>
      <div class="chart-container">
        <canvas id="probabilityChart"></canvas>
      </div>
      <div id="confidenceInfo" class="mb-2 mt-2 text-center">
        <!-- Confidence level info will be displayed here -->
      </div>
    </div>
    
    <div class="note mb-3">
      <p><strong>Note:</strong> This calculator estimates the average attempts required to achieve your target plus level from your selected starting point. The chart shows the probability distribution and the number of attempts needed to reach your specified confidence level.</p>
    </div>
  </div>

  <script>
    // Initialize calculator state
    const state = {
      baseRates: {
        1: 0.95,
        2: 0.90,
        3: 0.85,
        4: 0.70,
        5: 0.60,
        6: 0.50,
        7: 0.30,
        8: 0.20,
        9: 0.10
      },
      talismanOptions: [
        { name: "None", rate: 0 },
        { name: "+18% Talisman", rate: 0.18 },
        { name: "+20% Talisman", rate: 0.20 },
        { name: "+25% Talisman", rate: 0.25 },
        { name: "+30% Talisman", rate: 0.30 },
        { name: "+50% Talisman", rate: 0.50 }
      ],
      talismanStrategy: {
        1: 0, // Index of talismanOptions for each plus level
        2: 0,
        3: 0,
        4: 0,
        5: 0,
        6: 0,
        7: 0,
        8: 0,
        9: 0
      },
      startingPoint: 0,
      targetPlus: 9,
      confidenceLevel: 95,
      compoundRates: {}, // Calculated compound success rates
      charts: {
        probability: null
      }
    };
    
    // DOM References
    const elements = {
      configurationTable: document.getElementById('configurationTable'),
      startingPoint: document.getElementById('startingPoint'),
      targetPlus: document.getElementById('targetPlus'),
      confidenceLevel: document.getElementById('confidenceLevel'),
      targetError: document.getElementById('targetError'),
      calculateButton: document.getElementById('calculateButton'),
      resultsContainer: document.getElementById('resultsContainer'),
      probabilityChart: document.getElementById('probabilityChart'),
      confidenceInfo: document.getElementById('confidenceInfo')
    };
    
    // Initialize Configuration Table
    function initConfigurationTable() {
      if (!elements.configurationTable) return;
      
      const tableBody = elements.configurationTable.querySelector('tbody');
      tableBody.innerHTML = '';
      
      // Calculate compound success rates first
      calculateCompoundRates();
      
      for (let plus = 1; plus <= 9; plus++) {
        const row = document.createElement('tr');
        
        // Plus column
        const plusCell = document.createElement('td');
        plusCell.textContent = `+${plus}`;
        
        // Base Success Rate column
        const rateCell = document.createElement('td');
        rateCell.textContent = `${(state.baseRates[plus] * 100).toFixed(0)}%`;
        rateCell.className = 'text-right';
        
        // Talisman column
        const talismanCell = document.createElement('td');
        const selectEl = document.createElement('select');
        selectEl.id = `talisman-${plus}`;
        
        state.talismanOptions.forEach((option, index) => {
          const optionEl = document.createElement('option');
          optionEl.value = index;
          optionEl.textContent = option.name;
          selectEl.appendChild(optionEl);
        });
        
        selectEl.value = state.talismanStrategy[plus];
        selectEl.addEventListener('change', (e) => {
          state.talismanStrategy[plus] = parseInt(e.target.value);
          updateConfigurationTable();
        });
        
        talismanCell.appendChild(selectEl);
        
        // Total Success Rate column
        const totalRateCell = document.createElement('td');
        totalRateCell.className = 'text-right';
        totalRateCell.id = `total-rate-${plus}`;
        totalRateCell.textContent = calculateTotalSuccessRate(plus).toFixed(2) + '%';
        
        // Compound Success Rate column
        const compoundRateCell = document.createElement('td');
        compoundRateCell.className = 'text-right';
        compoundRateCell.id = `compound-rate-${plus}`;
        compoundRateCell.textContent = (state.compoundRates[plus] * 100).toFixed(2) + '%';
        
        row.appendChild(plusCell);
        row.appendChild(rateCell);
        row.appendChild(talismanCell);
        row.appendChild(totalRateCell);
        row.appendChild(compoundRateCell);
        tableBody.appendChild(row);
      }
    }
    
    // Calculate total success rate for a plus level
    function calculateTotalSuccessRate(plus) {
      const baseRate = state.baseRates[plus];
      const talismanIndex = state.talismanStrategy[plus];
      const talismanBoost = state.talismanOptions[talismanIndex].rate;
      
      // Cap the rate at 100%
      return Math.min(100, (baseRate + talismanBoost) * 100);
    }
    
    // Calculate compound success rates
    function calculateCompoundRates() {
      let compoundRate = 1.0; // Start with 100%
      
      for (let plus = 1; plus <= 9; plus++) {
        const totalRate = calculateTotalSuccessRate(plus) / 100;
        compoundRate *= totalRate;
        state.compoundRates[plus] = compoundRate;
      }
    }
    
    // Update configuration table
    function updateConfigurationTable() {
      // Recalculate compound rates
      calculateCompoundRates();
      
      // Update the display
      for (let plus = 1; plus <= 9; plus++) {
        const totalRateCell = document.getElementById(`total-rate-${plus}`);
        if (totalRateCell) {
          totalRateCell.textContent = calculateTotalSuccessRate(plus).toFixed(2) + '%';
        }
        
        const compoundRateCell = document.getElementById(`compound-rate-${plus}`);
        if (compoundRateCell) {
          compoundRateCell.textContent = (state.compoundRates[plus] * 100).toFixed(2) + '%';
        }
      }
    }
    
    // Validate the starting point and target plus selections
    function validateSelections() {
      const startingPoint = parseInt(elements.startingPoint.value);
      const targetPlus = parseInt(elements.targetPlus.value);
      
      if (targetPlus <= startingPoint) {
        elements.targetError.textContent = "Target plus level must be higher than starting point";
        return false;
      }
      
      elements.targetError.textContent = "";
      return true;
    }
    
    // Calculate success probability from starting point to target
    function calculateSuccessProbability() {
      const startingPoint = parseInt(state.startingPoint);
      const targetPlus = parseInt(state.targetPlus);
      
      // Calculate compound success rate from starting point to target
      let startProb = 1;
      if (startingPoint > 0) {
        startProb = state.compoundRates[startingPoint];
      }
      
      const targetProb = state.compoundRates[targetPlus];
      
      // The probability of success from starting point to target
      return targetProb / startProb;
    }
    
    // Calculate average attempts
    function calculateAverageAttempts() {
      const successProb = calculateSuccessProbability();
      // Average attempts is 1/probability
      return 1 / successProb;
    }
    
    // Calculate attempts needed for specified confidence level
    function calculateConfidenceAttempts(confidenceLevel) {
      const successProb = calculateSuccessProbability();
      
      // Convert percentage to decimal
      const confidence = confidenceLevel / 100;
      
      // For geometric distribution, the cumulative probability function is:
      // P(X <= n) = 1 - (1 - p)^n
      // Solving for n: n = log(1 - confidence) / log(1 - p)
      
      // Special case for very small probabilities to avoid division by zero
      if (successProb < 0.0000001) {
        return Number.MAX_SAFE_INTEGER; // Effectively infinity
      }
      
      const denominator = Math.log(1 - successProb);
      // Check for division by very small number
      if (Math.abs(denominator) < 0.0000001) {
        return Number.MAX_SAFE_INTEGER; // Effectively infinity
      }
      
      const attempts = Math.log(1 - confidence) / denominator;
      return Math.ceil(attempts); // Round up to the next whole number
    }
    
    // Generate probability distribution data
    function generateProbabilityData() {
      const successProb = calculateSuccessProbability();
      const averageAttempts = 1 / successProb;
      
      // Generate data for 3x the average attempts (or 50, whichever is smaller)
      const maxAttempts = Math.min(Math.ceil(averageAttempts * 3), 50);
      
      const data = [];
      let cumulativeProbability = 0;
      
      for (let attempt = 1; attempt <= maxAttempts; attempt++) {
        // Probability of success exactly on attempt i for geometric distribution
        // P(X = i) = p * (1-p)^(i-1)
        const probability = successProb * Math.pow(1 - successProb, attempt - 1);
        
        // Cumulative probability
        cumulativeProbability += probability;
        
        data.push({
          attempt,
          probability,
          cumulativeProbability
        });
      }
      
      return data;
    }
    
    // Update the probability chart
    function updateProbabilityChart() {
      // Destroy existing chart if it exists
      if (state.charts.probability) {
        state.charts.probability.destroy();
      }
      
      if (!elements.probabilityChart) return;
      
      const probabilityData = generateProbabilityData();
      
      // Prepare chart data
      const chartData = {
        labels: probabilityData.map(d => d.attempt),
        datasets: [
          {
            label: 'Success Probability',
            data: probabilityData.map(d => d.probability * 100), // Convert to percentage
            backgroundColor: 'rgba(88, 101, 242, 0.5)',
            borderColor: 'rgba(88, 101, 242, 1)',
            borderWidth: 1
          },
          {
            label: 'Cumulative Probability',
            data: probabilityData.map(d => d.cumulativeProbability * 100), // Convert to percentage
            backgroundColor: 'rgba(59, 165, 92, 0.5)',
            borderColor: 'rgba(59, 165, 92, 1)',
            borderWidth: 1,
            type: 'line'
          }
        ]
      };
      
      // Create chart
      const ctx = elements.probabilityChart.getContext('2d');
      state.charts.probability = new Chart(ctx, {
        type: 'bar',
        data: chartData,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              title: {
                display: true,
                text: 'Number of Attempts',
                color: '#dcddde'
              },
              ticks: {
                color: '#b9bbbe'
              },
              grid: {
                color: 'rgba(255, 255, 255, 0.1)'
              }
            },
            y: {
              title: {
                display: true,
                text: 'Probability (%)',
                color: '#dcddde'
              },
              ticks: {
                color: '#b9bbbe'
              },
              grid: {
                color: 'rgba(255, 255, 255, 0.1)'
              }
            }
          },
          plugins: {
            legend: {
              labels: {
                color: '#dcddde'
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.dataset.label || '';
                  const value = context.raw.toFixed(2);
                  return `${label}: ${value}%`;
                }
              }
            }
          }
        }
      });
      
      // Update confidence info
      const confidenceAttempts = calculateConfidenceAttempts(state.confidenceLevel);
      const confidenceInfo = elements.confidenceInfo;
      
      if (confidenceInfo) {
        confidenceInfo.innerHTML = `
          <div>
            <strong>${state.confidenceLevel}% Confidence:</strong> 
            You need <strong>${confidenceAttempts}</strong> attempts to have a 
            ${state.confidenceLevel}% chance of reaching +${state.targetPlus} from +${state.startingPoint}
          </div>
        `;
      }
    }
    
    // Main calculation function
    function calculate() {
      if (!validateSelections()) {
        return;
      }
      
      // Update state with current values
      state.startingPoint = parseInt(elements.startingPoint.value);
      state.targetPlus = parseInt(elements.targetPlus.value);
      state.confidenceLevel = parseFloat(elements.confidenceLevel.value);
      
      // Clamp confidence level to valid range
      if (state.confidenceLevel < 1) state.confidenceLevel = 1;
      if (state.confidenceLevel > 99.99) state.confidenceLevel = 99.99;
      
      // Calculate average attempts
      const averageAttempts = calculateAverageAttempts();
      const confidenceAttempts = calculateConfidenceAttempts(state.confidenceLevel);
      
      // Update results display
      updateResults(averageAttempts, confidenceAttempts);
      
      // Update probability chart
      updateProbabilityChart();
    }
    
    // Update results display
    function updateResults(attempts, confidenceAttempts) {
      const resultsContainer = elements.resultsContainer;
      if (!resultsContainer) return;
      
      // Calculate the success probability percentage
      const successProb = calculateSuccessProbability();
      
      resultsContainer.innerHTML = `
        <p class="mb-2">
          <strong>From +${state.startingPoint} to +${state.targetPlus}:</strong>
        </p>
        <p class="mb-2">
          Expected attempts: <strong>${attempts.toFixed(2)}</strong>
        </p>
        <p class="mb-2">
          Success probability per attempt: <strong>${(successProb * 100).toFixed(2)}%</strong>
        </p>
        <p>
          Attempts needed for ${state.confidenceLevel}% confidence: <strong>${confidenceAttempts}</strong>
        </p>
      `;
    }
    
    // Event listeners
    function attachEventListeners() {
      if (elements.calculateButton) {
        elements.calculateButton.addEventListener('click', calculate);
      }
      
      if (elements.startingPoint) {
        elements.startingPoint.addEventListener('change', function() {
          state.startingPoint = parseInt(this.value);
          validateSelections();
        });
      }
      
      if (elements.targetPlus) {
        elements.targetPlus.addEventListener('change', function() {
          state.targetPlus = parseInt(this.value);
          validateSelections();
        });
      }
      
      if (elements.confidenceLevel) {
        elements.confidenceLevel.addEventListener('input', function() {
          state.confidenceLevel = parseFloat(this.value);
        });
      }
    }
    
    // Initialize the app
    function initApp() {
      try {
        console.log("Initializing application...");
        
        // Initialize tables and attach event listeners
        initConfigurationTable();
        attachEventListeners();
        
        // Initial validation
        validateSelections();
        
        console.log("Initialization complete");
      } catch (error) {
        console.error("Error during initialization:", error);
      }
    }
    
    // Start the app when DOM is loaded
    document.addEventListener('DOMContentLoaded', initApp);
  </script>
</body>
</html>